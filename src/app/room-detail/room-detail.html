<!-- THANH TR∆Ø·ª¢T -->
<nav class="room-tabs">
    <a class="tab active" (click)="scrollToSection('overview')">T·ªïng quan</a>
    <a class="tab" (click)="scrollToSection('rooms')">D·ªãch v·ª• & G√≥i ƒëi k√®m</a>
    <a class="tab" (click)="scrollToSection('policy')">Ch√≠nh s√°ch</a>
    <a class="tab" (click)="scrollToSection('reviews')">ƒê√°nh gi√°</a>
</nav>

<!-- N·ªòI DUNG -->
<!-- TH√îNG TIN T·ªîNG QUAN -->
<section id="overview" class="room-overview" *ngIf="room">
    <div class="room-container">

        <!-- ·∫¢NH CH√çNH -->
        <div class="image-section">
            <div class="main-photo-wrapper">
                <img [src]="room.photos[currentSlide]" alt="·∫¢nh ch√≠nh" class="main-photo"
                    (click)="openPopup(room.photos[currentSlide])" />
                <button class="prev" (click)="prevSlide()">&lt;</button>
                <button class="next" (click)="nextSlide()">&gt;</button>
            </div>

            <div class="thumbs">
                <img *ngFor="let img of room.photos; let i = index" [src]="img"
                    [class.active-thumb]="i === currentSlide" (click)="selectSlide(i)" alt="thumb" />
            </div>
        </div>

        <!-- POPUP XEM ·∫¢NH G·ªêC -->
        <div class="image-popup" *ngIf="popupImage" (click)="closePopup()">
            <div class="popup-content" (click)="$event.stopPropagation()">
                <button class="nav-btn prev" (click)="prevPopupImage($event)">&#10094;</button>
                <img [src]="popupImage" alt="·∫¢nh ph√≥ng to" />
                <button class="nav-btn next" (click)="nextPopupImage($event)">&#10095;</button>
                <button class="close-btn" (click)="closePopup()">√ó</button>
            </div>
        </div>

        <!-- TH√îNG TIN PH√íNG -->
        <div class="room-info-card-horizontal shadow-lg">
            <div class="row g-4 align-items-center">

                <!-- LEFT INFO -->
                <div class="col-md-7 room-left">
                    <h2 class="room-title mb-2">{{ room.room_name }}</h2>
                    <p class="room-type mb-2">{{ room.range }} ¬∑ {{ room.tags?.[0] }} </p>
                    <div class="rating mb-2">
                        <i class="bi bi-star-fill text-warning"></i>
                        <span class="fw-semibold">{{ averageRating }}</span>/5
                        <span class="text-muted ms-1">({{ totalReviews }} l∆∞·ª£t ƒë√°nh gi√°)</span>
                    </div>

                    <p class="room-status available" *ngIf="room.available">
                        <i class="bi bi-check-circle-fill text-primary me-1"></i>
                        ƒêang m·ªü ƒë·∫∑t ph√≤ng
                    </p>
                </div>

                <!-- RIGHT PRICE + ACTION -->
                <div class="col-md-5 room-right">
                    <div class="price-box text-md-end text-center mb-3">
                        <p class="price-label mb-1 fw-semibold text-muted">Gi√°/ph√≤ng/gi·ªù</p>
                        <p class="room-price mb-0">{{ room.price | currency:'VND' }}</p>
                    </div>
                </div>

                <div class="booking-form p-3 rounded-3 shadow-sm border border-1 border-light-subtle bg-white">
                    <div class="row g-2 align-items-center mb-3">
                        <div class="col-6">
                            <label for="date" class="form-label fw-semibold small text-secondary">Ng√†y</label>
                            <input id="date" type="date" class="form-control border-primary-subtle"
                                [(ngModel)]="selectedDate" />
                        </div>

                        <div class="col-6">
                            <label for="time" class="form-label fw-semibold small text-secondary">Gi·ªù</label>
                            <select id="time" class="form-select border-primary-subtle" [(ngModel)]="selectedTime">
                                <option value="" disabled selected>-- Ch·ªçn gi·ªù --</option>
                                <option *ngFor="let slot of timeSlots" [value]="slot">{{ slot }}</option>
                            </select>
                        </div>
                    </div>

                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-warning" (click)="addToCart()">
                            <i class="bi bi-cart-plus me-1"></i> Th√™m v√†o gi·ªè h√†ng
                        </button>

                        <button class="btn btn-primary" (click)="selectRoom()">
                            <i class="bi bi-calendar-check me-1"></i> Thanh to√°n ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- M√î T·∫¢ CHI TI·∫æT -->
        <div class="room-description" *ngIf="room.long_description">
            <h3>Gi·ªõi thi·ªáu</h3>
            <p [class.expanded]="isExpanded"> {{ room.long_description }} </p>
            <button class="btn-toggle" (click)="toggleDescription()">
                {{ isExpanded ? 'Thu g·ªçn ‚ñ≤' : 'Xem th√™m ‚ñº' }}
            </button>
        </div>
    </div>
</section>

<!-- TH√îNG TIN & GI√Å PH√íNG -->
<section id="rooms" class="room-packages">
    <h2>D·ªãch v·ª• & G√≥i ƒëi k√®m</h2>

    <!-- D·ªäCH V·ª§ CHUY√äN GIA -->
    <div class="package-expert">
        <h3>D·ªãch v·ª• chuy√™n gia</h3>
        <div class="service-item"
            *ngFor="let ex of expertServices | slice:0:(showAllExperts ? expertServices.length : 4)">
            <input type="checkbox" [(ngModel)]="ex.selected" (change)="updateTotal()" />
            <div class="service-content">
                <div class="service-top">
                    <h4>{{ ex.name }}</h4>
                </div>
                <p>{{ ex.description }}</p>
            </div>

            <div class="service-right">
                <span class="service-price">{{ ex.price | currency:'VND' }}</span>
            </div>
        </div>

        <!-- N√∫t xem th√™m -->
        <div class="show-more-wrapper" *ngIf="expertServices.length > 4">
            <button class="btn-show-more" (click)="showAllExperts = !showAllExperts">
                {{ showAllExperts ? 'Thu g·ªçn ‚ñ≤' : 'Xem th√™m ‚ñº' }}
            </button>
        </div>
    </div>

    <!-- D·ªäCH V·ª§ THU√ä TH√äM -->
    <div class="package-extra">
        <h3>D·ªãch v·ª• thu√™ th√™m</h3>
        <div class="service-item" *ngFor="let s of extraServices | slice:0:(showAllExtras ? extraServices.length : 4)">
            <input type="checkbox" [(ngModel)]="s.selected" (change)="updateTotal()" />
            <div class="service-content">
                <h4>{{ s.name }}</h4>
                <p>{{ s.description }}</p>
            </div>

            <div class="service-right">
                <span class="service-price">{{ s.price | currency:'VND' }}</span>
                <div class="input-group quantity-control">
                    <button class="btn btn-primary btn-sm" type="button"
                        (click)="s.quantity = Math.max(1, s.quantity - 1); updateTotal()">‚àí
                    </button>
                    <input type="number" class="form-control text-center border-primary" [(ngModel)]="s.quantity"
                        min="1" max="10" (input)="updateTotal()" />
                    <button class="btn btn-primary btn-sm" type="button"
                        (click)="s.quantity = Math.min(10, s.quantity + 1); updateTotal()">+
                    </button>
                </div>
            </div>
        </div>

        <!-- N√∫t xem th√™m -->
        <div class="show-more-wrapper" *ngIf="extraServices.length > 4">
            <button class="btn-show-more" (click)="showAllExtras = !showAllExtras">
                {{ showAllExtras ? 'Thu g·ªçn ‚ñ≤' : 'Xem th√™m ‚ñº' }}
            </button>
        </div>
    </div>

    <!-- T·ªîNG K·∫æT GI√Å -->
    <div class="total-summary">
        <p>T·ªïng c·ªông:</p>
        <h3>{{ totalPrice | currency:'VND' }}</h3>
    </div>
</section>

<!-- CH√çNH S√ÅCH -->
<section id="policy" class="policy-section">
    <div class="container">
        <h2>Quy t·∫Øc chung</h2>
        <p class="subtitle">D·ªãch v·ª• √°p d·ª•ng m·ªôt s·ªë quy t·∫Øc sau - b·∫°n vui l√≤ng ki·ªÉm tra k·ªπ tr∆∞·ªõc khi ƒë·∫∑t ph√≤ng.</p>

        <div class="policy-item">
            <i class="bi bi-box-arrow-in-right"></i>
            <div class="policy-content">
                <h4>Nh·∫≠n ph√≤ng</h4>
                <p>Vui l√≤ng ƒë·∫øn ƒë√∫ng gi·ªù, khuy·∫øn kh√≠ch ƒë·∫øn s·ªõm h∆°n<strong> 10 ph√∫t.</strong></p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-clock-history"></i>
            <div class="policy-content">
                <h4>Tr·∫£ ph√≤ng tr·ªÖ / Gia h·∫°n</h4>
                <p>Tr·∫£ ph√≤ng tr·ªÖ h∆°n quy ƒë·ªãnh s·∫Ω c√≥ √°p d·ª•ng ph·ª• ph√≠. <br>
                    N·∫øu mu·ªën s·ª≠ d·ª•ng th√™m gi·ªù, vui l√≤ng gia h·∫°n th·ªùi gian v√† ƒë∆∞·ª£c ti·∫øn h√†nh x·ª≠ l√Ω nh∆∞ m·ªôt ƒë∆°n ƒë·∫∑t ph√≤ng
                    m·ªõi, v·ªõi h√≥a ƒë∆°n v√† quy tr√¨nh ki·ªÉm tra ƒëi·ªÅu ki·ªán nh∆∞ th√¥ng th∆∞·ªùng.</p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-x-octagon"></i>
            <div class="policy-content">
                <h4>D·ªãch v·ª• k√®m th√™m</h4>
                <p>Kh√¥ng h·ªó tr·ª£ ƒë·∫∑t th√™m "D·ªãch v·ª• chuy√™n gia" trong qu√° tr√¨nh s·ª≠ d·ª•ng</p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-credit-card"></i>
            <div class="policy-content">
                <h4>Thanh to√°n</h4>
                <p>D√π ƒë·∫∑t tr·ª±c ti·∫øp hay tr·ª±c tuy·∫øn ph·∫£i thanh to√°n to√†n b·ªô h√≥a ƒë∆°n trong v√≤ng 10‚Äì30 ph√∫t t√≠nh t·ª´ l√∫c x√°c
                    nh·∫≠n ƒë·∫∑t ph√≤ng. <br>
                    Kh√¥ng ch·∫•p nh·∫≠n thanh to√°n m·ªôt ph·∫ßn; n·∫øu qu√° h·∫°n, ƒë∆°n s·∫Ω t·ª± ƒë·ªông h·ªßy.</p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-calendar-x"></i>
            <div class="policy-content">
                <h4>H·ªßy ƒë·∫∑t ph√≤ng / Thay ƒë·ªïi gi·ªù</h4>
                <p>Ch√≠nh s√°ch h·ªßy v√† ƒëi·ªÅu ch·ªânh gi·ªù c√≥ th·ªÉ kh√°c nhau theo t·ª´ng lo·∫°i ph√≤ng. Vui l√≤ng ki·ªÉm tra ƒëi·ªÅu ki·ªán
                    c·ª• th·ªÉ khi ƒë·∫∑t.</p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-person-check"></i>
            <div class="policy-content">
                <h4>ƒê·ªô tu·ªïi t·ªëi thi·ªÉu</h4>
                <p>ƒê·ªô tu·ªïi t·ªëi thi·ªÉu ƒë·ªÉ nh·∫≠n ph√≤ng l√† 18 tu·ªïi. Kh√°ch nh·ªè tu·ªïi ph·∫£i c√≥ ng∆∞·ªùi l·ªõn ƒëi c√πng khi nh·∫≠n ph√≤ng.
                </p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-slash-circle"></i>
            <div class="policy-content">
                <h4>H√∫t thu·ªëc</h4>
                <p>Kh√¥ng cho ph√©p h√∫t thu·ªëc trong ph√≤ng. Ch·ªâ ƒë∆∞·ª£c ph√©p h√∫t thu·ªëc trong khu v·ª±c ch·ªâ ƒë·ªãnh.</p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-people"></i>
            <div class="policy-content">
                <h4>Ti·ªác t√πng / S·ª± ki·ªán</h4>
                <p>Kh√¥ng cho ph√©p t·ªï ch·ª©c ti·ªác t√πng ho·∫∑c s·ª± ki·ªán.</p>
            </div>
        </div>

        <div class="policy-item">
            <i class="bi bi-ban"></i>
            <div class="policy-content">
                <h4>Th√∫ c∆∞ng</h4>
                <p>Kh√¥ng ƒë∆∞·ª£c mang theo th√∫ c∆∞ng.</p>
            </div>
        </div>
    </div>
</section>


<!-- ƒê√ÅNH GI√Å -->
<section id="reviews" class="review-section">
    <div class="container">
        <h2>ƒê√°nh gi√° t·ª´ kh√°ch h√†ng</h2>

        <div class="review-summary" *ngIf="totalReviews > 0">
            <div class="avg-rating">
                <span class="score">{{ averageRating }}</span>
                <span class="outof">/5</span>
            </div>
            <p>{{ totalReviews }} l∆∞·ª£t ƒë√°nh gi√°</p>
        </div>

        <div class="review-list" *ngIf="reviews.length > 0">
            <div class="review-card" *ngFor="let r of reviews">
                <div class="review-header">
                    <strong>{{ r.user }}</strong>
                    <span class="stars">
                        {{ '‚≠ê'.repeat(r.rating) }}
                        <span class="rating-number">{{ r.rating }}/5</span>
                    </span>
                </div>
                <p class="comment">"{{ r.comment }}"</p>
                <small class="date">{{ r.date | date:'dd/MM/yyyy' }}</small>
            </div>
        </div>

        <div class="no-reviews" *ngIf="reviews.length === 0">
            <p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho ph√≤ng n√†y.</p>
        </div>
    </div>
</section>

<!-- üõí GI·ªé H√ÄNG N·ªîI -->
<div class="cart-floating" (click)="toggleCart()">
    <i class="bi bi-cart-fill"></i>
    <span class="cart-count" *ngIf="cartCount > 0">{{ cartCount }}</span>
</div>

<!-- POPUP GI·ªé H√ÄNG -->
<div class="cart-popup" *ngIf="isCartOpen" (click)="toggleCart()">
    <div class="cart-popup-content" (click)="$event.stopPropagation()">
        <h5 class="cart-title"><i class="bi bi-cart-check me-2"></i>Gi·ªè h√†ng</h5>

        <div *ngIf="cart.length > 0; else emptyCart">
            <div class="cart-item" *ngFor="let item of cart; let i = index">
                <img [src]="item.photo" alt="·∫¢nh ph√≤ng" class="cart-img" />
                <div class="cart-info">
                    <h6>{{ item.roomName }}</h6>
                    <p>{{ item.date }} ¬∑ {{ item.time }}</p>
                    <div *ngIf="item.expertServices?.length">
                        <small class="text-primary">D·ªãch v·ª• chuy√™n gia:</small>
                        <ul>
                            <li *ngFor="let ex of item.expertServices">{{ ex.name }} (+{{ ex.price | currency:'VND' }})
                            </li>
                        </ul>
                    </div>
                    <div *ngIf="item.extraServices?.length">
                        <small class="text-primary">D·ªãch v·ª• th√™m:</small>
                        <ul>
                            <li *ngFor="let s of item.extraServices">{{ s.name }} x{{ s.quantity }} (+{{ s.total |
                                currency:'VND' }})</li>
                        </ul>
                    </div>
                    <span class="price">{{ item.totalPrice | currency:'VND' }}</span>
                </div>

                <button class="btn-remove" (click)="removeFromCart(i)">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="cart-summary">
                <p>T·ªïng c·ªông: <strong>{{ getCartTotal() | currency:'VND' }}</strong></p>
                <button class="btn btn-primary w-100 fw-semibold" (click)="goToPayment()">Thanh to√°n</button>
            </div>
        </div>

        <ng-template #emptyCart>
            <p class="text-center text-muted">Ch∆∞a c√≥ ph√≤ng n√†o trong gi·ªè.</p>
        </ng-template>
    </div>
</div>